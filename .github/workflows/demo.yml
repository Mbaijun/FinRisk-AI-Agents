name: Daily Demo Deploy

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 0点运行
  workflow_dispatch:       # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run and Expose with Ngrok
        run: |
          # 1. 安装 ngrok 和 jq
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ./ngrok
          sudo apt-get update && sudo apt-get install -y jq curl

          # 2. 配置 ngrok 认证令牌
          ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

          # 3. 在后台启动你的 Gradio 应用
          python demo_gradio.py &
          APP_PID=$!
          echo "Gradio app started with PID: $APP_PID"
          sleep 10 # 等待应用启动

          # 4. 启动 ngrok 暴露 7860 端口，并保持在后台运行
          ./ngrok http 7860 --log stdout > ngrok.log &
          NGROK_PID=$!
          echo "ngrok started with PID: $NGROK_PID"
          sleep 10 # 等待 ngrok 建立隧道

          # 5. 从 ngrok 的 API 获取公共 URL
          PUBLIC_URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          if [ -z "$PUBLIC_URL" ] || [ "$PUBLIC_URL" = "null" ]; then
            echo "ERROR: Failed to get public URL. Ngrok log:"
            cat ngrok.log
            exit 1
          fi
          echo "✅ Public URL: $PUBLIC_URL"
          echo "This URL will be active for a short period after this workflow ends."

          # 6. 【关键】在这里结束工作流，让链接在ngrok免费计划的有效期内（约2小时）可访问。
          # 工作流成功结束，链接已生成。
          # 注意：工作流结束后，Gradio和ngrok进程也会被终止，免费链接很快会失效。
          # 若需长时间演示，需使用其他托管服务（如Vercel, Railway, Hugging Face Spaces）。
