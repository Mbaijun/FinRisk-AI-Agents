name: Daily Demo Deploy

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 0点运行
  workflow_dispatch:       # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run and Expose with Ngrok
        run: |
          # 1. 安装依赖
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ./ngrok
          sudo apt-get update && sudo apt-get install -y jq curl

          # 2. 配置认证
          ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

          # 3. 启动应用 (使用nohup，忽略挂断信号)
          echo "启动 Gradio 应用..."
          nohup python demo_gradio.py > app.log 2>&1 &
          APP_PID=$!
          echo "应用PID: $APP_PID"
          sleep 15

          # 4. 启动 ngrok (同样使用nohup)
          echo "启动 ngrok 隧道..."
          nohup ./ngrok http 7860 --log stdout > ngrok.log 2>&1 &
          NGROK_PID=$!
          echo "ngrok PID: $NGROK_PID"
          sleep 25

          # 5. 获取公共URL
          PUBLIC_URL=$(curl -s localhost:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url')
          if [ -n "$PUBLIC_URL" ] && [ "$PUBLIC_URL" != "null" ]; then
            echo "✅ 隧道建立成功！Public URL: $PUBLIC_URL"
            echo "⚠️  此工作流将保持运行最多6小时。链接在此期间有效。"
            echo "⚠️  要停止演示，请手动取消此工作流运行。"
            
            # 6. 【关键】无限等待，保持作业活跃，直到手动取消或超时
            while true; do
              sleep 300  # 每5分钟打印一次状态，表明还活着
              echo "[心跳] 演示仍在运行中... $(date)"
            done
          else
            echo "❌ 错误：无法获取公共URL。"
            exit 1
          fi
