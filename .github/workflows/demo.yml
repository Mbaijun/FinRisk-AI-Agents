name: Daily Demo Deploy

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 ï¼ˆåŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹ï¼‰è¿è¡Œä¸€æ¬¡ï¼Œç”Ÿæˆæ–°çš„ngroké“¾æ¥
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'æµ‹è¯•éƒ¨ç½²'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: pip install gradio

    - name: Run Gradio app in background
      run: |
        python run_simple.py &
        sleep 5  # ç­‰å¾…åº”ç”¨å¯åŠ¨

    - name: Setup ngrok
      uses: crazy-max/ghaction-setup-ngrok@v3
      with:
        authtoken: ${{ secrets.NGROK_AUTHTOKEN }}

    - name: Expose app and update README
      run: |
        # å¯åŠ¨ngrokå¹¶è·å–å…¬å…±URL
        ngrok http 7860 > /dev/null &
        sleep 5
        PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "Public URL: $PUBLIC_URL"
        
        # ç”¨æ–°é“¾æ¥æ›´æ–°README.md
        sed -i "s|https://.*ngrok-free\.dev|$PUBLIC_URL|g" README.md
        
        # é…ç½®Gitå¹¶æ¨é€æ›´æ–°
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        git add README.md
        git commit -m "ğŸ¤– Auto-update demo link: $PUBLIC_URL" || echo "No changes to commit"
        git push