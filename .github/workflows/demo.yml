name: Daily Demo Deploy

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC 0点运行
  workflow_dispatch:       # 允许手动触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run and Expose with Ngrok
        run: |
          # 1. 安装依赖
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ./ngrok
          sudo apt-get update && sudo apt-get install -y jq curl

          # 2. 配置认证
          ./ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

          # 3. 启动应用 (注意：需确认 demo_gradio.py 是否监听 7860 端口)
          echo "启动 Gradio 应用..."
          python demo_gradio.py &
          APP_PID=$!
          sleep 15 # 重要：给予应用更长的启动时间

          # 4. 启动 ngrok 并记录日志
          echo "启动 ngrok 隧道..."
          ./ngrok http 7860 --log stdout > ngrok.log &
          NGROK_PID=$!
          sleep 25 # 关键：给予足够时间建立稳定隧道

          # 5. 尝试获取公共URL (重试机制，修正了jq命令)
          echo "尝试获取公共 URL..."
          MAX_RETRY=3
          for i in $(seq 1 $MAX_RETRY); do
            # 修正点：将 2>/dev/null 移至 curl 命令后
            PUBLIC_URL=$(curl -s localhost:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[0].public_url')
            if [ -n "$PUBLIC_URL" ] && [ "$PUBLIC_URL" != "null" ]; then
              echo "✅ 成功！Public URL: $PUBLIC_URL"
              echo "提示：此链接为临时链接，有效时间有限。"
              break
            else
              echo "尝试 $i/$MAX_RETRY 获取失败，等待重试..."
              sleep 10
            fi
          done

          # 6. 如果最终失败，输出错误日志
          if [ -z "$PUBLIC_URL" ] || [ "$PUBLIC_URL" = "null" ]; then
            echo "❌ 错误：无法获取公共URL。请检查以下日志："
            echo "=== 应用启动状态 ==="
            ps aux | grep python
            echo "=== ngrok 日志 (最后20行) ==="
            tail -20 ngrok.log
            echo "=== ngrok API 状态 ==="
            curl -s localhost:4040/api/tunnels || echo "无法连接到 ngrok API"
            exit 1
          fi

          # 7. 获取成功后，保持进程运行一小段时间以确保隧道激活
          echo "隧道已建立。工作流即将完成，链接在短时间内可用。"
          sleep 30
