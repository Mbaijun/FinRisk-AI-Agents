import yfinance as yf
import pandas as pd
import numpy as np
from typing import List, Dict
import time

class RiskAnalyzer:
    def __init__(self, risk_free_rate: float = 0.02):
        self.risk_free_rate = risk_free_rate
    
    def analyze_portfolio(self, symbols: List[str], weights: List[float]) -> Dict:
        try:
            print(f"开始下载数据: {symbols}")
            
            # 使用更稳定的下载方式
            data_list = []
            for symbol in symbols:
                try:
                    ticker = yf.Ticker(symbol)
                    hist = ticker.history(period="1mo")  # 使用1个月数据
                    if not hist.empty:
                        data_list.append(hist['Close'].rename(symbol))
                        print(f"  {symbol}: 获取到 {len(hist)} 条数据")
                    else:
                        print(f"  {symbol}: 无数据")
                        return {"success": False, "error": f"No data for {symbol}"}
                except Exception as e:
                    print(f"  {symbol} 错误: {e}")
                    return {"success": False, "error": f"Failed to fetch {symbol}: {str(e)}"}
            
            # 合并数据
            data = pd.concat(data_list, axis=1).dropna()
            if data.empty:
                return {"success": False, "error": "No valid data after merging"}
            
            print(f"合并后数据形状: {data.shape}")
            
            # 计算收益率
            returns = data.pct_change().dropna()
            if returns.empty:
                return {"success": False, "error": "No returns data"}
            
            # 计算组合收益率
            portfolio_returns = (returns * weights).sum(axis=1)
            
            # 计算风险指标
            volatility = portfolio_returns.std() * np.sqrt(252)
            var_95 = -np.percentile(portfolio_returns, 5)
            sharpe = (portfolio_returns.mean() * 252 - self.risk_free_rate) / volatility if volatility > 0 else 0
            
            return {
                "success": True,
                "volatility": float(volatility),
                "var_95": float(var_95),
                "sharpe": float(sharpe),
                "data_points": len(portfolio_returns)
            }
            
        except Exception as e:
            return {"success": False, "error": str(e)}